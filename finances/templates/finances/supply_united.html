{% extends 'base.html' %}

{% block content %}

    <div class="container50">

        <form action= "{% url 'url_supply_united' %}" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <p id="id_link_create_bank_account">Le compte en banque n'est pas dans la liste ? <a href="{% url 'url_create_bank_account' %}?next=/finances/supply/united">Ajout !</a></p>
            <input type=hidden name="next" value="{{ next }}" />
            <input type="submit" value="Submit" id="id_submit"/>
        </form>

    </div>

    <script>
        var type = document.getElementById('id_type');
        var bank_account = document.getElementById('id_bank_account');
        var link_bank_account_create = document.getElementById('id_link_create_bank_account');
        var signature_date = document.getElementById('id_signature_date');
        var unique_number = document.getElementById('id_unique_number');
        var labels = document.getElementsByTagName('LABEL');
        for (var i = 0; i < labels.length; i++) {
            if (labels[i].htmlFor != '') {
                var elem = document.getElementById(labels[i].htmlFor);
                if (elem)
                    elem.label = labels[i];
            }
        }

        bank_account.style.display = 'None';
        bank_account.label.style.display = 'None';
        link_bank_account_create.style.display = 'None';
        signature_date.style.display = 'None';
        signature_date.label.style.display = 'None';
        unique_number.style.display = 'None';
        unique_number.label.style.display = 'None';

        type.addEventListener('change', function(e) {
            if (e.target.value === 'cheque') {
                bank_account.style.display = '';
                bank_account.label.style.display = '';
                link_bank_account_create.style.display = '';
                signature_date.style.display = '';
                signature_date.label.style.display = '';
                unique_number.style.display = '';
                unique_number.label.style.display = '';
            }
            else if (e.target.value === 'cash') {
                bank_account.style.display = 'None';
                bank_account.label.style.display = 'None';
                link_bank_account_create.style.display = 'None';
                signature_date.style.display = 'None';
                signature_date.label.style.display = 'None';
                unique_number.style.display = 'None';
                unique_number.label.style.display = 'None';
            }
            else if (e.target.value === 'lydia') {
                bank_account.style.display = 'None';
                bank_account.label.style.display = 'None';
                link_bank_account_create.style.display = 'None';
                signature_date.style.display = '';
                signature_date.label.style.display = '';
                unique_number.style.display = '';
                unique_number.label.style.display = '';
            }
        }, false);


    </script>
    <script>
        // Il faut supprimer les choix pour qu'ils n'apparaissent pas
        // Cependant ils doivent être dans la liste initiale (dans le form), sinon django n'est pas d'accord et ne valide pas
        var select = document.getElementById('id_bank_account');
        while (select.firstChild) {
            select.removeChild(select.firstChild);
        }
        document.getElementById('id_sender').addEventListener('blur', function() {
            // Remise à zéro des selects avant le changement
            var select = document.getElementById('id_bank_account');
            while (select.firstChild) {
                select.removeChild(select.firstChild);
            }
            var sender_elmt = document.getElementById('id_sender');
            var username = sender_elmt.value;

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url 'url_bank_account_from_user' %}?user_username=' + username);
            xhr.send(null);

            xhr.addEventListener('readystatechange', function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var parser = new DOMParser();
                    var XMLxhr = parser.parseFromString(xhr.responseText, "application/xml");

                    var list_xml_object = XMLxhr.getElementsByTagName('object');

                    for (var i = 0, c = list_xml_object.length ; i < c ; i++) {

                        var add_select = document.createElement('option');
                        add_select.setAttribute('value', list_xml_object[i].getAttribute('pk'));

                        var add_select_str = list_xml_object[i].getElementsByTagName('field')[0].innerHTML +
                                ' ' + list_xml_object[i].getElementsByTagName('field')[1].innerHTML;
                        add_select.text = add_select_str;

                        add_select.setAttribute('selected', 'selected');

                        document.getElementById('id_bank_account').appendChild(add_select);
                    }
                }
            }, false);

        }, false);

    </script>
    <script>
        div_results_sender = document.createElement('div');
        div_results_sender.setAttribute('id', 'results_sender');
        div_results_operator = document.createElement('div');
        div_results_operator.setAttribute('id', 'results_operator');
        var searchElementSender = document.getElementById('id_sender');
        var searchElementOperator = document.getElementById('id_operator_username');
        var passwordElementOperator = document.getElementById('id_operator_password');
        var submitElement = document.getElementById('id_submit');
        submitElement.disabled = 'disabled';
        searchElementOperator.setAttribute('autocomplete', 'off');
        searchElementSender.setAttribute('autocomplete', 'off');
        insertAfter(div_results_operator, searchElementOperator);
        insertAfter(div_results_sender, searchElementSender);

        passwordElementOperator.addEventListener('focus', function() {
            if (searchElementOperator.value != '') {
                submitElement.disabled = '';
            }
        }, false);
        (function() {
            var searchElement = document.getElementById('id_sender'),
                    results = document.getElementById('results_sender'),
                    selectedResult = -1, // Permet de savoir quel résultat est sélectionné : -1 signifie "aucune sélection"
                    previousRequest, // On stocke notre précédente requête dans cette variable
                    previousValue = searchElement.value; // On fait de même avec la précédente valeur

            function getResults(keywords) { // Effectue une requête et récupère les résultats
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{% url 'url_username_from_username_part' %}?keywords=' + keywords);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        displayResults(xhr.responseText);
                    }
                };
                xhr.send(null);
                return xhr;
            }

            function displayResults(response) { // Affiche les résultats d'une requête
                results.style.display = response.length ? 'block' : 'none'; // On cache le conteneur si on n'a pas de résultats
                if (response.length) { // On ne modifie les résultats que si on en a obtenu
                    response = response.split('|');
                    var responseLen = response.length;
                    results.innerHTML = ''; // On vide les résultats
                    for (var i = 0, div ; i < responseLen ; i++) {
                        div = results.appendChild(document.createElement('div'));
                        div.innerHTML = response[i];
                        div.onclick = function() {
                            chooseResult(this);
                        };
                    }
                }
            }

            function chooseResult(result) { // Choisi un des résultats d'une requête et gère tout ce qui y est attaché
                searchElement.value = previousValue = result.innerHTML; // On change le contenu du champ de recherche et on enregistre en tant que précédente valeur
                results.style.display = 'none'; // On cache les résultats
                result.className = ''; // On supprime l'effet de focus
                selectedResult = -1; // On remet la sélection à "zéro"
                searchElement.focus(); // Si le résultat a été choisi par le biais d'un clique alors le focus est perdu, donc on le réattribue
            }

            searchElement.addEventListener('blur', function() {
                results.style.display = 'none'; // On cache les résultats
            }, false);

            searchElement.onkeyup = function(e) {
                e = e || window.event; // On n'oublie pas la compatibilité pour IE
                var divs = results.getElementsByTagName('div');
                if (e.keyCode == 38 && selectedResult > -1) { // Si la touche pressée est la flèche "haut"
                    divs[selectedResult--].className = '';
                    if (selectedResult > -1) { // Cette condition évite une modification de childNodes[-1], qui n'existe pas, bien entendu
                        divs[selectedResult].className = 'result_focus';
                    }
                }

                else if (e.keyCode == 40 && selectedResult < divs.length - 1) { // Si la touche pressée est la flèche "bas"
                    results.style.display = 'block'; // On affiche les résultats

                    if (selectedResult > -1) { // Cette condition évite une modification de childNodes[-1], qui n'existe pas, bien entendu
                        divs[selectedResult].className = '';
                    }
                    divs[++selectedResult].className = 'result_focus';
                    searchElement.value = divs[selectedResult].innerHTML;
                }
                else if (e.keyCode == 39 && selectedResult > -1) { // Si la touche pressée est "flèche de droite"
                    chooseResult(divs[selectedResult]);
                }
                else if (e.keyCode == 13 && selectedResult > -1) { // Si la touche pressée est "entrée"
                    chooseResult(divs[selectedResult]);
                }
                else if (searchElement.value != previousValue) { // Si le contenu du champ de recherche a changé
                    previousValue = searchElement.value;
                    if (previousRequest && previousRequest.readyState < 4) {
                        previousRequest.abort(); // Si on a toujours une requête en cours, on l'arrête
                    }
                    previousRequest = getResults(previousValue); // On stocke la nouvelle requête
                    selectedResult = -1; // On remet la sélection à "zéro" à chaque caractère écrit
                }
            };
        })();
        (function() {
            var searchElement = document.getElementById('id_operator_username'),
                    passwordElement = document.getElementById('id_operator_password'),
                    results = document.getElementById('results_operator'),
                    selectedResult = -1, // Permet de savoir quel résultat est sélectionné : -1 signifie "aucune sélection"
                    previousRequest, // On stocke notre précédente requête dans cette variable
                    previousValue = searchElement.value; // On fait de même avec la précédente valeur

            function getResults(keywords) { // Effectue une requête et récupère les résultats
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{% url 'url_username_from_username_part' %}?keywords=' + keywords);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        displayResults(xhr.responseText);
                    }
                };
                xhr.send(null);
                return xhr;
            }

            function displayResults(response) { // Affiche les résultats d'une requête
                results.style.display = response.length ? 'block' : 'none'; // On cache le conteneur si on n'a pas de résultats
                if (response.length) { // On ne modifie les résultats que si on en a obtenu
                    response = response.split('|');
                    var responseLen = response.length;
                    results.innerHTML = ''; // On vide les résultats
                    for (var i = 0, div ; i < responseLen ; i++) {
                        div = results.appendChild(document.createElement('div'));
                        div.innerHTML = response[i];
                        div.onclick = function() {
                            chooseResult(this);
                        };
                    }
                }
            }

            function chooseResult(result) { // Choisi un des résultats d'une requête et gère tout ce qui y est attaché
                searchElement.value = previousValue = result.innerHTML; // On change le contenu du champ de recherche et on enregistre en tant que précédente valeur
                results.style.display = 'none'; // On cache les résultats
                result.className = ''; // On supprime l'effet de focus
                selectedResult = -1; // On remet la sélection à "zéro"
                searchElement.focus(); // Si le résultat a été choisi par le biais d'un clique alors le focus est perdu, donc on le réattribue
            }

            searchElement.addEventListener('blur', function() {
                results.style.display = 'none'; // On cache les résultats
            }, false);

            searchElement.onkeyup = function(e) {
                e = e || window.event; // On n'oublie pas la compatibilité pour IE
                var divs = results.getElementsByTagName('div');
                if (e.keyCode == 38 && selectedResult > -1) { // Si la touche pressée est la flèche "haut"
                    divs[selectedResult--].className = '';
                    if (selectedResult > -1) { // Cette condition évite une modification de childNodes[-1], qui n'existe pas, bien entendu
                        divs[selectedResult].className = 'result_focus';
                    }
                }

                else if (e.keyCode == 40 && selectedResult < divs.length - 1) { // Si la touche pressée est la flèche "bas"
                    results.style.display = 'block'; // On affiche les résultats

                    if (selectedResult > -1) { // Cette condition évite une modification de childNodes[-1], qui n'existe pas, bien entendu
                        divs[selectedResult].className = '';
                    }
                    divs[++selectedResult].className = 'result_focus';
                    searchElement.value = divs[selectedResult].innerHTML;
                }
                else if (e.keyCode == 39 && selectedResult > -1) { // Si la touche pressée est "flèche de droite"
                    chooseResult(divs[selectedResult]);
                }
                else if (e.keyCode == 13 && selectedResult > -1) { // Si la touche pressée est "entrée"
                    chooseResult(divs[selectedResult]);
                    passwordElement.focus();
                }
                else if (searchElement.value != previousValue) { // Si le contenu du champ de recherche a changé
                    previousValue = searchElement.value;
                    if (previousRequest && previousRequest.readyState < 4) {
                        previousRequest.abort(); // Si on a toujours une requête en cours, on l'arrête
                    }
                    previousRequest = getResults(previousValue); // On stocke la nouvelle requête
                    selectedResult = -1; // On remet la sélection à "zéro" à chaque caractère écrit
                }
            };
        })();

        function insertAfter(newElement, afterElement) {
            var parent = afterElement.parentNode;
            if (parent.lastChild === afterElement) { // Si le dernier élément est le même que l'élément après lequel on veut insérer, il suffit de faire appendChild()
                parent.appendChild(newElement);
            } else { // Dans le cas contraire, on fait un insertBefore() sur l'élément suivant
                parent.insertBefore(newElement, afterElement.nextSibling);
            }
        }
    </script>
{% endblock %}