{% extends 'base_sober.html' %}
{% load bootstrap %}
{% load finances_extra %}
{% load l10n %}

{% block content %}

{% if done == False %}
<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
  <div class="panel-heading">
    Mise à jour de l'événement
  </div>
  <div class="panel-body">
    <form action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}" method='post' class="form-horizontal">
        {% csrf_token %}
        <input type='hidden' name='action' value='update'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        {{ update_form|bootstrap_horizontal }}
        <div class="form-group">
          <div class="col-sm-10 col-sm-offset-2">
            <button type="submit" class="btn btn-success">Mise à jour</button>
            <a href="{% url 'url_sharedevent_finish' group_name=group.name pk=pk %}" role="button" class="btn btn-warning">Terminer</a>
            <a href="{% url 'url_sharedevent_delete' group_name=group.name pk=pk %}" role="button" class="btn btn-danger">Supprimer</a>
          </div>
        </div>
    </form>
  </div>
</div>
  </div>
  <div class="col-md-6">
    <div class="panel panel-default">
  <div class="panel-heading">
    Chargement d'un fichier
  </div>
  <div class="panel-body">
    <form enctype="multipart/form-data" action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}"
    method='post' class="form-horizontal">
        {% csrf_token %}
        <input type='hidden' name='action' value='upload_json'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        {{ upload_json_form|bootstrap_horizontal }}
        <div class="form-group">
          <div class="col-sm-10 col-sm-offset-2">
            <button type="submit" class="btn btn-success">Upload</button>
          </div>
        </div>
    </form>
  </div>
</div>
  </div>
</div>
{% endif %}
<div class="panel panel-default">
  <div class="panel-heading">
    Téléchargement de fichiers Excels
  </div>
  <div class="panel-body">
    <form action= "{% url 'url_sharedevent_update' pk=pk group_name=group.name %}" method="post">
        {% csrf_token %}
            <span id="list_year">
                <label>{{ download_xlsx_form.state.label }}</label> {{ download_xlsx_form.state }}
                <label>Selectionner les années à inclure :</label>
                {% for f in download_xlsx_form %}
                    {% if f != download_xlsx_form.state %}
                        <span class="fieldWrapper">
                            {{ f.errors }}
                            {{ f.label }} : {{ f }}
                        </span>
                    {% endif %}
                {% endfor %}
            </span>
        <input type='hidden' name='action' value='download_xlsx'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        <input type="submit" value="Télécharger le fichier"/>
    </form>
  </div>
</div>
{% if perms.finances.proceed_payment_sharedevent %}
<div class="panel panel-default">
  <div class="panel-heading">
    Paiement
  </div>
  <div class="panel-body">
    {% if payment_error %}
      <div class="alert alert-danger"><a class="close" data-dismiss="alert">×</a>{{ payment_error }}</div>
	{% endif %}
    Etat : {% human_reading done 'shared_event_done' %}. {% if done %}{{ remark }}{% endif %}
    {% if done == False %}
    <a href="{% url 'url_sharedevent_proceed_payment' pk=pk group_name=group.name %}" class="btn btn-danger">Procéder au paiement</a>
    {% endif %}
  </div>
</div>
{% endif %}
<div class="panel panel-default">
  <div class="panel-heading">
    Gestion manuelle
  </div>
  <div class="panel-body">
    <form action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}#table_users" method='post'>
        {% csrf_token %}
        <input type='hidden' name='action' value='list_user'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        <p>{{ list_user_form.state.error }}
          {{ list_user_form.state.label }} : {{ list_user_form.state }}
            {{ list_user_form.order_by.error }}
            {{ list_user_form.order_by.label }} : {{ list_user_form.order_by }}
             <button type='submit' class="btn btn-default">Lister</button></p>
    </form>
    {% if done == False %}
        <form action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}#table_users" method='post'>
            {% csrf_token %}
            <input type='hidden' name='action' value='add_user'>
            <input type=hidden name="state" value="{{ state }}" />
            <input type=hidden name="order_by" value="{{ order_by }}" />
            <input type=hidden name="next" value="{{ next }}" />
            {{ add_user_form.username.error_messages }} {{ add_user_form.state.error_messages }} {{ add_user_form.ponderation.error_messages }}
            <p>
              {{ add_user_form.username.error }}
              {{ add_user_form.username.label }} : {{ add_user_form.username }}

              {{ add_user_form.state.error }}{{ add_user_form.state }}

              {{ add_user_form.ponderation.error }}
              {{ add_user_form.ponderation.label }} : {{ add_user_form.ponderation }}
              <button type='submit' class="btn btn-warning">Ajouter</button>
            </p>
        </form>
    {% endif %}
  </div>
</div>

{% include "finances/_sharedevent_list_users.html" %}

{% if done == False %}
<script>
    // Modification à la volée de la pondération
    // Apres la modification (blur ou enter), requete ajax pour modifier la pondération
    {% for u in query_user %}
        var old_ponderation;
        $('#ponderation_{{ u.0.pk }}').on('focus', function() {
            old_ponderation = $(this).val();
        }).change(function() {
            if ($(this).val() != old_ponderation) {
                $.ajax({
                    method: "GET",
                    url: "{% url 'url_sharedevent_change_ponderation' group_name=group.name pk=pk participant_pk=u.0.pk %}",
                    data: {
                        pond: $(this).val()
                    },
                    success: function (response) {
                        if (response == 0) {
                            $('#ponderation_{{ u.0.pk }}').val(old_ponderation);
                        }
                    },
                    error: function() {
                        $('#ponderation_{{ u.0.pk }}').val(old_ponderation);
                    }
                })
            }
        });
    {% endfor %}

</script>
{% endif %}

<script>
{% if price %}
  {% if not done %}
  set_prices_input()
  $("[id^='ponderation_']").change(function() {
    set_prices_input()
  })
  {% endif %}
{% endif %}

  function total_ponderation_txt () {
    var total_ponderation = 0
    $("[id^='ponderation_']").each(function() {
      var id = $(this).attr('id').split('_')[1]
      total_ponderation += Number($('#ponderation_' + id).text())
    })
    return total_ponderation
  }

  function price_per_ponderation_txt () {
    return {{ price|unlocalize }} / total_ponderation_txt()
  }

  function total_ponderation_input () {
    var total_ponderation = 0
    $("[id^='ponderation_']").each(function() {
      var id = $(this).attr('id').split('_')[1]
      total_ponderation += Number($('#ponderation_' + id).val())
    })
    return total_ponderation
  }

  function price_per_ponderation_input () {
    return {{ price|unlocalize }} / total_ponderation_input()
  }

  function set_prices_input () {
    $("[id^='ponderation_']").each(function() {
      var id = $(this).attr('id').split('_')[1]
      var ponderation = $(this).val()
      var r_price = Math.round(Number(ponderation * price_per_ponderation_input()*100))/100
      $("#price_" + id).text(r_price + '€')
    })
  }
</script>

{% endblock %}
