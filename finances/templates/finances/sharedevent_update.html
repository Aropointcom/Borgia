{% extends 'base_sober.html' %}
{% load bootstrap %}
{% load finances_extra %}
{% load l10n %}

{% block content %}

{% if done == False %}
<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
  <div class="panel-heading">
    Mise à jour de l'événement
  </div>
  <div class="panel-body">
    <form action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}" method='post' class="form-horizontal">
        {% csrf_token %}
        <input type="hidden" name='action' value="update">
        <input type="hidden" name="state" value="{{ state }}" />
        <input type="hidden" name="order_by" value="{{ order_by }}" />
        <input type="hidden" name="next" value="{{ next }}" />
        {{ update_form|bootstrap_horizontal }}
        <div class="form-group">
          <div class="col-sm-10 col-sm-offset-2">
            <button type="submit" class="btn btn-success">Mise à jour</button>
            <a href="{% url 'url_sharedevent_finish' group_name=group.name pk=pk %}" role="button" class="btn btn-warning">Terminer</a>
            <a href="{% url 'url_sharedevent_delete' group_name=group.name pk=pk %}" role="button" class="btn btn-danger">Supprimer</a>
          </div>
        </div>
    </form>
  </div>
</div>
  </div>
  <div class="col-md-6">
    <div class="panel panel-default">
  <div class="panel-heading">
    Chargement d'un fichier
  </div>
  <div class="panel-body">
    <form enctype="multipart/form-data" action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}"
    method='post' class="form-horizontal">
        {% csrf_token %}
        <input type='hidden' name='action' value='upload_json'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        {{ upload_json_form|bootstrap_horizontal }}
        <div class="form-group">
          <div class="col-sm-10 col-sm-offset-2">
            <button type="submit" class="btn btn-success">Upload</button>
          </div>
        </div>
    </form>
  </div>
</div>
  </div>
</div>
{% endif %}
<!-- <div class="panel panel-default">
  <div class="panel-heading">
    Téléchargement de fichiers Excels
  </div>
  <div class="panel-body">
    <form action= "{% url 'url_sharedevent_update' pk=pk group_name=group.name %}" method="post">
        {% csrf_token %}
            <span id="list_year">
                <label>{{ download_xlsx_form.state.label }}</label> {{ download_xlsx_form.state }}
                <label>Selectionner les années à inclure :</label>
                {% for f in download_xlsx_form %}
                    {% if f != download_xlsx_form.state %}
                        <span class="fieldWrapper">
                            {{ f.errors }}
                            {{ f.label }} : {{ f }}
                        </span>
                    {% endif %}
                {% endfor %}
            </span>
        <input type='hidden' name='action' value='download_xlsx'>
        <input type=hidden name="state" value="{{ state }}" />
        <input type=hidden name="order_by" value="{{ order_by }}" />
        <input type=hidden name="next" value="{{ next }}" />
        <input type="submit" value="Télécharger le fichier"/>
    </form>
  </div>
</div> -->
{% if perms.finances.proceed_payment_sharedevent %}
<!-- <div class="panel panel-default">
  <div class="panel-heading">
    Paiement
  </div>
  <div class="panel-body">
    {% if payment_error %}
      <div class="alert alert-danger"><a class="close" data-dismiss="alert">×</a>{{ payment_error }}</div>
	{% endif %}
    Etat : {% human_reading done 'shared_event_done' %}. {% if done %}{{ remark }}{% endif %}
    {% if done == False %}
    <a href="{% url 'url_sharedevent_proceed_payment' pk=pk group_name=group.name %}" class="btn btn-danger">Procéder au paiement</a>
    {% endif %}
  </div>
</div> -->
{% endif %}
<div class="panel panel-default">
  <div class="panel-heading">
    Gestion manuelle
  </div>
  <div class="panel-body">
    <form action="{% url 'url_sharedevent_update' pk=pk group_name=group.name %}#table_users" method='get'>
        <p>{{ list_users_form.state.error }}
          {{ list_users_form.state.label }} : {{ list_users_form.state }}
            {{ list_users_form.order_by.error }}
            {{ list_users_form.order_by.label }} : {{ list_users_form.order_by }}
             <button type='submit' class="btn btn-default">Lister</button></p>
    </form>


    {% if done == False %}
        <form action="{% url 'url_sharedevent_add_weight' pk=pk group_name=group.name %}" method='post'>
            {% csrf_token %}
            {{ add_weight_form.username.error_messages }} {{ add_weight_form.state.error_messages }} {{ add_weight_form.weight.error_messages }}
            <p>
              {{ add_weight_form.username.error }}
              {{ add_weight_form.username.label }} : {{ add_weight_form.username }}

              {{ add_weight_form.state.error }}{{ add_weight_form.state }}

              {{ add_weight_form.weight.error }}
              {{ add_weight_form.weight.label }} : {{ add_weight_form.weight }}
              <button type='submit' class="btn btn-warning">Ajouter</button>
            </p>
        </form>
    {% endif %}
  </div>
</div>

{% include "finances/_sharedevent_list_users.html" %}

{% if not done %}

<script type="text/javascript">
    // Modification à la volée de la pondération
    // Apres la modification (blur ou enter), requete ajax pour modifier la pondération
    {% for u in list_weights %}
        $('#participant_weight_{{ u.0.pk }}').change( function (){
          send_data("{% url 'url_sharedevent_change_weight' group_name=group.name pk=pk participant_pk=u.0.pk %}", $(this).val(), 1);
        });

        $('#registered_weight_{{ u.0.pk }}').change( function (){
          send_data("{% url 'url_sharedevent_change_weight' group_name=group.name pk=pk participant_pk=u.0.pk %}", $(this).val(), 0);
        });
    {% endfor %}

    function send_data (unique_url, new_weight, int_isParticipant) {
          $.ajax({
              method: "GET",
              url: unique_url,
              data: {
                  pond: new_weight,
                  isParticipant: int_isParticipant
              },
              success: function (response) {

              },
              error: function() {
              }
          });
    };

</script>

  {% if price %}
    {% if state == "participants" or state == "registrants" %}
      {% load static %}
      <script src="{% static 'js/shared_event/calculate_users_price.js' %}" >
      </script>
    {% endif %}
  {% endif %}
{% endif %}



{% endblock %}
