{% load staticfiles %}
{% load notifications_extra %}
{% load users_extra %}

{% if user.is_authenticated %}
    {{ request|filter_get_unread_notifications_for_user }}
{% endif %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Borgia - V2.7.4</title>
    <link rel="stylesheet" href="{% static 'css/skeleton.css' %}" />
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style-xsmall.css' %}" />
    <link rel="stylesheet" href="{% static 'css/font-awesome.css' %}"/>
    <link rel="shortcut icon" type="image/png" href="{% static 'img/fav_borgia.jpg' %}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="{% static 'jquery-ui-1.11.4/jquery-ui.js' %}"></script>
    <script src="{% static 'js/widgets.js' %}"></script>
    <link rel="stylesheet" href="{% static 'jquery-ui-1.11.4/jquery-ui.css' %}">

    <script type="text/javascript">
        function show_hide_div(id)
        {
            if(document.getElementById(id).style.visibility=="hidden")
            {
                document.getElementById(id).style.visibility="visible";
            }
            else
            {
                document.getElementById(id).style.visibility="hidden";
            }
            return true;
        }

        var read_count = 0;
        var display_count = 0;

        function display_notification()
        {
            for (display_count; display_count<10; display_count++)
            {
                $("#container-notifications-hidden>div:first").insertBefore($(".notifications-footer"))
            }

            if (display_count + read_count < {{ messages|length }})
            {
                document.querySelector('.notifications-footer').firstElementChild.innerHTML=({{ messages|length }}-read_count-display_count).toString()+' autres messages. Tout afficher.';
            }
            else
            {
                document.querySelector('.notifications-footer').firstElementChild.innerHTML='Afficher toutes les notifications.';
            }


        }

        function make_notification_read_and_undisplay_it(id)
        {
            document.getElementById('container-notifications').removeChild(document.getElementById(id));

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url 'url_read_notification' %}?notification_id=' + id);
            xhr.send(null);

            read_count = read_count + 1;
            display_count = display_count - 1;

            display_notification()

            if (read_count < {{ messages|length }})
            {
                document.querySelector('span.buble-notifications-count').innerHTML=({{ messages|length }}-read_count).toString();
            }
            else
            {
                document.querySelector('span.buble-notifications-count').style.visibility="hidden";
            }
        }

    </script>
</head>
<body>

<div class="wrapper overlay">
    <nav class="navbar navbar-inverse navbar-fixed-top">

        <div class="container-fluid">
             <div class="navbar-header col-md-1 col-xs-2">
                 <a class="navbar-brand" href="{% url 'url_profile' %}">
                    Borgia
                 </a>
             </div>
             {% if user.is_authenticated %}
                <div id="wrapper-user-menu" class="col-md-6 col-xs-6">
             {% else %}
                 <div id="wrapper-user-menu" class="col-md-3 col-xs-5">
             {% endif %}
                <ul class="user-menu">
                    {% if user.is_authenticated %}
                        <!-- <li><a class="icon icon-people" href="{% url 'url_list_user' %}"></a></li> -->
                        <li>
                            <span class="icon icon-notification" onclick="show_hide_div('container-notifications');">
                            </span>
                            {% if messages %}
                                <span class="buble-notifications-count" onclick="show_hide_div('container-notifications');">
                                </span>
                            {% endif %}</li>
                        <!-- <li><a class="icon icon-settings" href=""></a></li> -->
                        <li><a class="icon icon-connexion" href="{% url 'django.contrib.auth.views.logout' %}">Logout</a></li>
                        <!-- <li><a class="icon icon-admin" href=""></a></li> -->
                    {% else %}
                        <li><a class="icon icon-connexion" href="{% url 'django.contrib.auth.views.login' %}">Login</a></li>
                        <li><a class="icon icon-beer" href="{% url 'url_login_pg' organe='foyer' %}">Conso. Foyer</a></li>
                    {% endif %}
                </ul>
             </div>
             {% if user.is_authenticated %}
                    <div id="wrapper-user" class="col-md-5 col-xs-5">
             {% else %}
                    <div id="wrapper-user" class="col-md-8 col-xs-5">
             {% endif %}
                {% if user.is_authenticated %}
                    <a class="user-container user-container-info" href="{% url 'url_update_user' pk=user.pk %}">
                        <h2 class="user-username">{{ user.surname }} {{ user.username }}</h2>
                        <small class="user-fullname">{{ user.first_name }} {{ user.last_name }}</small>
                        <span class="user-balance">{{ user.balance }} €</span>
                    </a>
                {% else %}
                    <form class="form-inline" action='' method="post">{% csrf_token %}
                        <div class="form-group">
                            <label class="icon icon-user" for="id_username"><span class="element-invisible">Nom d'utilisateur</span></label>
                            <input id="id_username" type="text" name="username" placeholder="Nom d'utilisateur" class="form-control autocomplete_username" maxlength="254" required>
                        </div>
                        <div class="form-group">
                            <label class="icon icon-lock" for="id_password"><span class="element-invisible">Mot de passe</span></label>
                            <input id="id_password" type="password" name="password" placeholder="Mot de passe" class="form-control" required>
                        </div>
                        <div class="form-group connexion">
                            <button id="id_submit" type="submit" class="btn classic-btn">Connexion</button>
                            <a href="{% url 'reset_password_reset1' %}">Mot de passe oublié ?</a>
                        </div>

                    </form>
                {% endif %}

             </form>
        </div>
    </nav>
</div>

{% if user.is_authenticated %}
    <div class="container" id="container-notifications-hidden">
        <script type="text/javascript">
            show_hide_div('container-notifications-hidden');
        </script>
        {% if messages %}
            {% for message in messages %}
                <div class="notifications-body{% if message.level_tag %} {{ message.level_tag }}{% endif %}" {% if message.extra_tags %} id="{{ message.extra_tags }}" {% endif %} >
                    <a onclick="make_notification_read_and_undisplay_it('{% if message.extra_tags %}{{ message.extra_tags }}{% endif %}');">{{ message|linebreaksbr}}<span class="icon icon-check-notification"></span></a>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="container" id="container-notifications">
        <script type="text/javascript">
            show_hide_div('container-notifications');
        </script>
        <div class="notifications-header">
            <h1 class="notifications-header">Nouvelles notifications:</h1>
        </div>
        {% if messages %}
        {% else %}
            <div class="notifications info">Il n'y a pas de nouvelles notifications pour toi.</div>
        {% endif %}
        <div class="notifications-footer">
            <a href="{% url 'url_list_complete_notification' %}">Tout afficher ...</a>
        </div>
        {% if messages %}
            <script type="text/javascript">
                display_notification()
            </script>
        {% endif %}
    </div>
{%  endif %}
<div class="container">
    {% if user.is_authenticated %}
        {% breadcrumbs %}
    {%  endif %}
    {%  block content %}
    {%  endblock %}
</div>
</body>

<footer class="container footer">
    <div class="credit">
        <div class="col-md-6">
           <small>
                     WIP - Borgia v2.7.4 - 25/11/2016 - <a href="http://wikiae.iresam.org/doku.php?id=borgia:historique_version_borgia">Historique des versions</a><br />
                     Borgia is an open-source project, developped by Arts et Métiers students.<br/>
                     Me214 - Pastys 101-99 & Elek 142<br />
                     Me215 - Eyap 53 & Leyphay'ss 87 & Rowsky 144<br />
           </small>
        </div>
        <div class="col-md-6">
            <small>
                CSS d'après <a href="https://yunohost.org">Yunohost</a><br/>
                <a href="http://fortawesome.github.io/Font-Awesome/">FontAwesome</a>
                <div class="ideas">
                    Un bug? Des remarques? Partage les nous! <input type="submit" value="Reporter un bug" id="mailto_report" class="btn-default">
                </div>
            </small>
         </div>
    </div>
    <script>
        document.getElementById("mailto_report").addEventListener('click', function(e) {
            window = window.open("mailto:support@iresam.org?Subject=Feedback Borgia", 'EmailWindow')
        }, false);
    </script>
</footer>

{% if user.is_authenticated %}
    {% if user.avatar %}
        <style>
            .user-container:before {
                background: url('{% static user.avatar.url %}') no-repeat 0 0;
                background-size: 100%;
                content: "";
            }
        </style>
    {% endif %}
{% endif %}

{% if messages %}
    <script type="text/javascript">
        document.querySelector('span.buble-notifications-count').innerHTML=({{ messages|length }}).toString();
    </script>
{% endif %}
</html>