{% load staticfiles %}
{% load notifications_extra %}
{% load users_extra %}

{% if user.is_authenticated %}
    {{ request|filter_get_unread_notifications_for_user }}
{% endif %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Borgia - V2.7.4</title>
    <link rel="stylesheet" href="{% static 'css/skeleton.css' %}" />
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style-xsmall.css' %}" />
    <link rel="stylesheet" href="{% static 'css/font-awesome.css' %}"/>
    <link rel="shortcut icon" type="image/png" href="{% static 'img/fav_borgia.png' %}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="{% static 'jquery-ui-1.11.4/jquery-ui.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/widgets.js' %}"></script>
    <link rel="stylesheet" href="{% static 'jquery-ui-1.11.4/jquery-ui.css' %}">

    <script type="text/javascript">
        function show_hide_div(id)
        {
            if(document.getElementById(id).style.visibility=="hidden")
            {
                document.getElementById(id).style.visibility="visible";
            }
            else
            {
                document.getElementById(id).style.visibility="hidden";
            }
            return true;
        }

        var read_count = 0;
        var display_count = 0;

        function display_notification()
        {
            for (display_count; display_count<10; display_count++)
            {
                $("#container-notifications-hidden>div:first").insertBefore($(".notifications-footer"))
            }

            if (display_count + read_count < {{ messages|length }})
            {
                document.querySelector('.notifications-footer').firstElementChild.innerHTML=({{ messages|length }}-read_count-display_count).toString()+' autres messages. Tout afficher.';
            }
            else
            {
                document.querySelector('.notifications-footer').firstElementChild.innerHTML='Afficher toutes les notifications.';
            }


        }

        function make_notification_read_and_undisplay_it(id)
        {
            document.getElementById('container-notifications').removeChild(document.getElementById(id));

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '{% url 'url_read_notification' %}?notification_id=' + id);
            xhr.send(null);

            read_count = read_count + 1;
            display_count = display_count - 1;

            display_notification();

            if (read_count < {{ messages|length }})
            {
                document.querySelector('span.buble-notifications-count').innerHTML=({{ messages|length }}-read_count).toString();
            }
            else
            {
                document.querySelector('span.buble-notifications-count').style.visibility="hidden";
            }
        }

    </script>
</head>
<body>
{% url 'url_page_clean' as url_clean %}
<div {% if user.is_authenticated and request.path != url_clean %} class="transparent-bcg" {% endif %}>
  <div class="wrapper overlay">
    <nav class="navbar navbar-inverse navbar-fixed-top">

        <div class="container-fluid">
             <div class="navbar-header col-md-2 col-sm-2 col-xs-2" style="padding-left: 2px">
                <a href="{% url 'url_purchase_foyer' %}">
                   <span style="background: url('{% static 'img/borgia_logo.svg' %}') no-repeat;" class="logo-background"></span>
                </a>
             </div>

            {% if user.is_authenticated %}
            <div id="wrapper-user-menu" class="col-md-3 col-sm-3 col-xs-3">

                <ul class="user-menu pull-left">

                        <li><a href="{% url 'url_supply_lydia_self' %}" title="Crédit Lydia"><div class="lydia"><span class="lydia-logo"></span><span class="lydia-text">Crédit compte</span></div></a></li>
                        <!-- <li><a class="icon icon-people" href="{% url 'url_list_user' %}"></a></li> -->
                        <!-- <li><a class="icon icon-settings" href=""></a></li> -->
                        <!-- <li><a class="icon icon-admin" href=""></a></li> -->

                </ul>
             </div>
             <div id="wrapper-user" class="col-md-7 col-sm-7 col-xs-7">

                    <span class="user-container mobileHide568">
                        <h2 class="user-username">{{ user.surname }} {{ user.username }}</h2>
                        <span class="user-balance {% if user.balance >= 0 %}posits {% else %}negats {% endif %}">{{ user.balance }} €</span>
                    </span>
                    <div class="row">
                        <ul class="user-menu pull-right" style="position:absolute; right: 0;">
                            <li><span class="user-connexion"><a class="icon icon-connexion" href="{% url 'django.contrib.auth.views.logout' %}" title="Déconnexion"></a></span></li>
                            <li><span class="user-edition"><a class="icon icon-pencil-grey" style="height: 23px;" href="{% url 'url_update_user' pk=user.pk %}" title="Édition"></a></span></li>
                            <li>
                                <span class="user-notification">
                                    <span class="icon icon-notification" onclick="show_hide_div('container-notifications');" title="Notifications">
                                    </span>
                                </span>
                                {% if messages %}
                                    <span class="buble-notifications-count" onclick="show_hide_div('container-notifications');">
                                    </span>
                                {% endif %}</li>
                        </ul>
                    </div>
             </div>

                {% else %}
                    <div id="user-wrapper" class="col-lg-10 col-lg-push-2 col-md-10 col-sm-10 col-xs-12">
                    <form class="form-inline" action='' method="post">{% csrf_token %}
                        <div class="form-group">
                            <label class="icon icon-user" for="id_username"><span class="element-invisible">Nom d'utilisateur</span></label>
                            <input id="id_username" type="text" name="username" placeholder="Nom d'utilisateur" class="form-control autocomplete_username" maxlength="254" required>
                        </div>
                        <div class="form-group">
                            <label class="icon icon-lock" for="id_password"><span class="element-invisible">Mot de passe</span></label>
                            <input id="id_password" type="password" name="password" placeholder="Mot de passe" class="form-control" required>
                        </div>
                        <div class="form-group connexion">
                            <button id="id_submit" type="submit" class="btn classic-btn">Connexion</button>
                            <a href="{% url 'reset_password_reset1' %}">Mot de passe oublié ?</a>
                        </div>

                    </form>
                    </div>
                {% endif %}
        </div>
    </nav>
  </div>

{% if user.is_authenticated %}
    <div class="container" id="container-notifications-hidden">
        <script type="text/javascript">
            show_hide_div('container-notifications-hidden');
        </script>
        {% if messages %}
            {% for message in messages %}
                <div class="notifications-body{% if message.level_tag %} {{ message.level_tag }}{% endif %}" {% if message.extra_tags %} id="{{ message.extra_tags }}" {% endif %} >
                    <a onclick="make_notification_read_and_undisplay_it('{% if message.extra_tags %}{{ message.extra_tags }}{% endif %}');">{{ message|linebreaksbr}}<span class="icon icon-check-notification"></span></a>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="container" id="container-notifications">
        <script type="text/javascript">
            show_hide_div('container-notifications');
        </script>
        <div class="notifications-header">
            <h3 class="notifications-header">Nouvelles notifications:</h3>
        </div>
        {% if messages %}
        {% else %}
            <div class="notifications info"> Il n'y a pas de nouvelles notifications pour toi.</div>
        {% endif %}
        <div class="notifications-footer">
            <a href="{% url 'url_list_complete_notification' %}">Tout afficher ...</a>
        </div>
        {% if messages %}
            <script type="text/javascript">
                display_notification()
            </script>
        {% endif %}
    </div>
{%  endif %}
<div class="container-fluid">
    {% if user.is_authenticated %}
        <div class="col-md-2 col-sm-2 col-xs-12">
            <ul class="list-group list_group_apps">
                {% url 'url_purchase_foyer' as url_foys %}
                {% url 'url_create_transfert' as url_transfert %}
                {% url 'url_list_shared_event' as url_event %}
                {% url 'url_profile' as url_profile %}
                <a href="{% if request.path  == url_foys %}{% url 'url_page_clean' %}{% else %}{{ url_foys}}{% endif %}"><li class="list-group-item list-foys {% if request.path  == url_foys %}list_group_apps_item_active{% endif %}"><img src="{% static 'img/tap.svg' %}" /><h3>Foy's</h3></li></a>
                <a href="#"><li class="list-group-item list-shops"><img src="{% static 'img/store.svg' %}" /><h3>Shop's</h3></li></a>
                <a href="{% if request.path  == url_transfert %}{% url 'url_page_clean' %}{% else %}{{ url_transfert}}{% endif %}"><li class="list-group-item list-transfert {% if request.path  == url_transfert %}list_group_apps_item_active{% endif %}"><img src="{% static 'img/transfer.svg' %}" /><h3>Transfert</h3></li></a>
                <a href="{% if request.path  == url_event %}{% url 'url_page_clean' %}{% else %}{{ url_event}}{% endif %}"><li class="list-group-item list-manips {% if request.path  == url_event %}list_group_apps_item_active{% endif %}"><img src="{% static 'img/event-calendar-symbol.svg' %}" /><h3>Manips</h3></li></a>
                <a href="#"><li class="list-group-item list-frais"><img src="{% static 'img/thief.svg' %}" /><h3>Frais AE</h3></li></a>
                <a href="{% if request.path  == url_profile %}{% url 'url_page_clean' %}{% else %}{{ url_profile}}{% endif %}"><li class="list-group-item list-bouls {% if request.path  == url_profile %}list_group_apps_item_active{% endif %}"><img src="{% static 'img/lazy.svg' %}" /><h3>Boul's</h3></li></a>
            </ul>
        </div>
    {% endif %}

    {% if user.is_authenticated %}
       <div class="col-md-10 col-sm-10 col-xs-12 offset" style="margin-top:30px;">
    {% else %}
       <div class="container-fluid">
    {% endif %}
        {%  block content %}
        {%  endblock %}
       </div>


</div>
</body>

{% if user.is_authenticated %}
    {% if user.avatar %}
        <style>
            .user-container:before {
                background: url('{% static user.avatar.url %}') no-repeat 0 0;
                background-size: 100%;
                content: "";
            }
        </style>
    {% endif %}
{% endif %}

{% if messages %}
    <script type="text/javascript">
        document.querySelector('span.buble-notifications-count').innerHTML=({{ messages|length }}).toString();
    </script>
{% endif %}
</html>