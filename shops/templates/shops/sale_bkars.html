{% extends 'base.html' %}

{% block content %}

    <form method="POST" action="{% url 'url_purchase_bkars' %}" id="form_purchase">
        {% csrf_token %}
        <div class="container-fluid">
            <div class="row">
                {{ form.non_field_errors }}
            </div>

            <div class="col-lg-push-2 col-md-7 col-md-push-3 col-sm-9 col-sm-push-2 col-xs-12">
                <div class="row well well-custom balance-debit">
                    <div class="fieldWrapper align-center">
                        {{ form.client_username.errors }}
                        <label for="{{ form.client_username.id_for_label }}">Client:</label>
                        {{ form.client_username }}
                        <h4><span class="user-balance" id="surname"></span></h4>
                    </div>
                    <div class="row-fluid align-center">
                        <h4>
                            <span class="user-balance"><span id="balance_before">0.00</span> € - <span id="total_consumption">0.00</span> € = <span id="balance_after">0.00</span></span>
                            <input type=hidden name="hidden_balance_after" id="hidden_balance_after" value="" />
                        </h4>
                        <input id="id_submit" class="self_submit" type=submit value="Valider"/><br>
                    </div>
                </div>
            </div>
        </div>
        <style>
            .self_submit {
                background: #4B99AD;
                padding: 5px !important;
                margin: 5px;
                border: none;
                color: #fff !important;
            }
        </style>
        <div id="div_purchase" class="container-fluid">
            <div class="row-fluid">
                <ul id="onglets" class="onglets-bkars">
                    <li id="li_single_product">Produits unitaires</li>
                </ul>
            </div>
            <div class="row-fluid">

                <div class="row-fluid" id="div_single_product">
                    <table class="table_shop">
                        <th class="mobileHide768">Raccourci</th>
                        <th>Produit</th>
                        <th>Prix</th>
                        <th>Nombre</th>
                        <th class="mobileHide768">Prix correspondant</th>

                        {% for e in dict_field_single_product %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td class="mobileHide768">{% if e.2 < 12 %}
                                        F{{ e.2|add:1 }}
                                    {% endif %}</td>
                                    <td>{{ e.1 }}</td>
                                    <td><span id="selected_initial_price_single_product_{{ e.2 }}">{{ e.1.get_moded_usual_price }}</span> €</td>
                                    <td class="number">{{ e.0 }}</td>
                                    <td class="mobileHide768"> <span id="selected_price_single_product_{{ e.2 }}">0.00</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}

                    </table>
                </div>

            </div>
        </div>
    </form>

    <script>
        onglets = document.getElementById('onglets');
        var li_list = onglets.getElementsByTagName('li');
        var div_list = [];
        var active_li = 0;
        var fields_list = [];
        var active_field = 0;

        div_list.push(document.getElementById('div_single_product'));

        var selected_quantity_single_product = [];
        var selected_price_single_product = [];
        var selected_initial_price_single_product = [];

        $("#id_client_username").blur(function() {
            var usersAPI = '{% url 'url_data_from_username' %}?username=' + document.getElementById('id_client_username').value
            $.getJSON( usersAPI, function( data ) {
                var sum = parseFloat(document.getElementById("total_consumption").textContent).toFixed(2);
                var diff = parseFloat(data['balance']-sum).toFixed(2);
                if (diff > 0) {
                    $("#balance_after").css("color", "#76CC81");
                } else {
                    $("#balance_after").css("color", "#e21E12");
                }

                $("#balance_before").text(parseFloat(data['balance']).toFixed(2));
                $("#balance_after").text(String(diff)+' €');
                $("#hidden_balance_after").val((String(diff)));
                $("#surname").text(data['surname'] + ' ' + data['family']);
            })
        });

        for (i=0; i<{{ single_product_available_list|length }}; i++) {
            selected_price_single_product.push(document.getElementById("selected_price_single_product_"+i));
            selected_quantity_single_product.push(document.getElementById("id_field_single_product_"+i));
            selected_initial_price_single_product.push(document.getElementById("selected_initial_price_single_product_"+i));
        }
        for (i=0;i<{{ single_product_available_list|length }};i++){
            (function(x) {
                selected_quantity_single_product[i].addEventListener('change', function(e) {
                    selected_price_single_product[x].textContent = String((e.target.value * Number(selected_initial_price_single_product[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }

        fields_list.push(selected_quantity_single_product);

        // initialisation -> Produits unitaires
        set_active_li(0);
        document.getElementById('li_single_product').addEventListener('click', function(e) {
            set_active_li(0);
        }, false);

        function set_active_li(new_active_li) {
            active_li = new_active_li;
            display_none_all(div_list[active_li]);
        }

        function set_active_field(new_active_field) {
            fields_list[active_li][new_active_field].focus();
            active_field = new_active_field;
        }



        function display_none_all(div_except) {
            for (i=0; i<div_list.length; i++) {
                if (div_list[i] != div_except) {
                    li_list[i].className = '';
                    div_list[i].style.display = 'none';
                }
                else {
                    div_list[i].style.display = 'block';
                    li_list[i].className = 'active';
                }
            }
        }


        function update_consumption() {
            var sum_single_product = 0;


            for (i=0; i<{{ single_product_available_list|length }}; i++) {
                sum_single_product += Number(document.getElementById("selected_price_single_product_" + i).textContent);
            }

            var balance_before = Number(document.getElementById("balance_before").textContent);
            document.getElementById("total_consumption").textContent = String((sum_single_product).toFixed(2));
            document.getElementById("balance_after").textContent = String((balance_before-sum_single_product).toFixed(2))+ ' €';
            if ((balance_before-sum_single_product)>=0) {
                document.getElementById("balance_after").style.color = "#76CC81";
            }
            else {
                document.getElementById("balance_after").style.color = "#e21E12";
            }
            document.getElementById("hidden_balance_after").value = (balance_before-sum_single_product).toFixed(2);
        }


        // initialisation

        var input_client_username = $("#id_client_username");
        if (input_client_username.val() != '') {
            input_client_username.focus();
            input_client_username.blur();
        }

        function recuperation_valeurs() {
            var a = 0;
            while (a <{{ single_product_available_list|length }}) {
                (function (a) {
                    return selected_quantity_single_product[a].dispatchEvent(new Event('change'));
                })(a);
                a++;
            }
        };
        recuperation_valeurs();

        setTimeout(function(){
            update_consumption()
        }, 1000);

        document.onkeydown = function (e) {
            if (!e.metaKey) {
                if (!($.inArray(e.keyCode, [8,9,13,46,96,97,98,99,100,101,102,103,104,105,48,49,50,51,52,53,54,55,56,57]) > -1)) {
                    e.preventDefault();
                }
            }

            // Problème du champ vide quand on valide

            if (e.keyCode == 13) {
                $("#div_purchase :input").each(
                        function () {
                            if ($(this).val() == '') {
                                $(this).val(0);
                            }
                        })
            }

            // Touches F1 à F12
            if (e.keyCode == 112) {
                fields_list[active_li][0].value = Number(fields_list[active_li][0].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][0].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 113) {
                fields_list[active_li][1].value = Number(fields_list[active_li][1].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][1].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 114) {
                fields_list[active_li][2].value = Number(fields_list[active_li][2].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][2].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 115) {
                fields_list[active_li][3].value = Number(fields_list[active_li][3].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][3].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 116) {
                fields_list[active_li][4].value = Number(fields_list[active_li][4].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][4].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 117) {
                fields_list[active_li][5].value = Number(fields_list[active_li][5].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][5].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 118) {
                fields_list[active_li][6].value = Number(fields_list[active_li][6].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][6].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 119) {
                fields_list[active_li][7].value = Number(fields_list[active_li][7].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][7].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 120) {
                fields_list[active_li][8].value = Number(fields_list[active_li][8].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][8].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 121) {
                fields_list[active_li][9].value = Number(fields_list[active_li][9].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][9].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 122) {
                fields_list[active_li][10].value = Number(fields_list[active_li][10].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][10].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 123) {
                fields_list[active_li][11].value = Number(fields_list[active_li][11].value) + 1;
                // erreur dans PyCharm mais fonctionnel
                fields_list[active_li][11].dispatchEvent(new Event('change'));
            }

            // Naviguation avec haut et bas à l'intérieur d'un div
            if (e.keyCode == 40) {
                if (active_field < fields_list[active_li].length-1) {
                    set_active_field(active_field+1);
                }
            }
            if (e.keyCode == 38) {
                if (active_field > 0) {
                    set_active_field(active_field-1);
                }
            }

            // Navigation avec gauche et droite
            if (e.keyCode == 37 && active_li>0) {
                set_active_li(active_li - 1);
                active_field = 0;
                set_active_field(0);
            }
            if (e.keyCode == 39 && active_li<li_list.length-1) {
                set_active_li(active_li + 1);
                active_field = 0;
                set_active_field(0);
            }

            // + et - pour ajouter ou enlever de la quantité
            if (e.keyCode == 107) {
                fields_list[active_li][active_field].value = Number(fields_list[active_li][active_field].value) + 1;
                fields_list[active_li][active_field].dispatchEvent(new Event('change'));
            }
            if (e.keyCode == 109) {
                if (Number(fields_list[active_li][active_field].value) > 0) {
                    fields_list[active_li][active_field].value = Number(fields_list[active_li][active_field].value) - 1;
                    fields_list[active_li][active_field].dispatchEvent(new Event('change'));
                }
            }
        };

        // Faire apparaître un header fixe pour la version mobile
        $(window).scroll(function () {
            if ($(window).width() < 768) {
                if ($(window).scrollTop() >= 215) {  //Phy'ss
                    $('.balance-debit').addClass('balance-debit-min');
                    $(".balance-debit").animate({"opacity": "1"}, 500);
                    $('#div_purchase').css('margin-top', '215px');
                    // $('#onglets').stop();
                    //$('#onglets').animate({'padding-top': '55px'}, 100);
                } else {
                    $('.balance-debit').stop();
                    $('.balance-debit').attr('style', '');
                    $('.balance-debit').removeClass('balance-debit-min');
                    $('#div_purchase').attr('style', '');
                    //$('#onglets').stop();
                    //$('#onglets').animate({'padding-top': '10px'}, 100);
                }
            }
        });
        // Les boutons sont générés uniquement pour la version mobile
        $(function() {
             if ($(window).width() < 768) {
                 $(".number").prepend('<span class="red-disabled btn-number">-</span>');
                 $(".number").append('<span class="posits btn-number">+</span>');
                 $("[type='number']").prop('readonly', 'readonly');
             }
        });
        $(document).ready(function() {
            $(".btn-number").on("click", function () {
                var button = $(this);
                var oldValue = button.parent().find("input").val();
                if (button.text() == "+") {
                    var newVal = parseFloat(oldValue) + 1;
                } else {
                    // On fait en sorte qu'on ne puisse pas avoir de valeur négative
                    if (oldValue > 0) {
                        var newVal = parseFloat(oldValue) - 1;
                    } else {
                        newVal = 0;
                    }
                }
                if (newVal == 0) {
                    if (button.text() == "+") {
                        button.parent().find(".red-disabled").css("background", "#e55e5e");
                    } else {
                        button.css("background", "#e55e5e");
                    }
                } else {
                    if (button.text() == "+") {
                        button.parent().find(".red-disabled").css("background", "#e21E12");
                    } else {
                        button.css("background", "#e21E12");
                    }
                }
                button.parent().find("input").val(newVal);
                // Prise en compte des changements
                recuperation_valeurs();
            });
        });

        //Surbrillance input au focus
        var inputs = document.getElementsByTagName("input");
            for(var i = 0; i < inputs.length; i++) {
            var el = inputs[i];
            while(el = el.parentNode) {
                if (el.nodeName.toLowerCase() === 'tr') {
                    inputs[i].onfocus = function () {
                        this.parentRow.style.backgroundColor = '#fff';
                        this.parentRow.style.color = '#000';

                    };
                    inputs[i].onblur = function () {
                        this.parentRow.style.backgroundColor = '';
                        this.parentRow.style.color = '';
                    };
                    inputs[i].parentRow = el;
                    break;
                }
            }
        }

    </script>

{% endblock %}