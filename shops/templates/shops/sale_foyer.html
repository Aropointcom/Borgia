{% extends 'base.html' %}

{% block content %}
    <form method="POST" action="{% url 'url_purchase_foyer' %}" id="form_purchase">
        {% csrf_token %}
        <div class="container">
            <div class="one-half column">
                <ul>
                    <li><strong>Username : </strong>{{ user.username }}</li>
                    <li>{{ user.surname }} {{ user.family }} {{ user.campus }}{{ user.year_pg }}</li>
                    <li><strong>Solde disponible : </strong><b id="balance_before">{{ user.balance }}</b><b> €</b></li>
                    <li><strong>Consommation : </strong><b id="total_consumption">0 </b><b> €</b></li>
                    <li><strong>Prévision du solde : </strong><b id="balance_after"></b><b> €</b></li>
                </ul>
            </div>
            <div class="one-half column">
                <input type=submit value="Valider">
            </div>
        </div>

        <div class="container50">
            <div class="row">
                <ul id="onglets">
                    <li id="li_active_keg_container">Tireuses à bières</li>
                    <li id="li_single_product">Produits unitaires</li>
                    <li id="li_liquor">Alcools forts</li>
                    <li id="li_syrup">Sirops</li>
                    <li id="li_soft">Soft</li>
                </ul>
            </div>
            <div class="row">
                <div class="row" id="div_active_keg_container">
                    <table>
                        <th>Bière</th>
                        <th>Prix 25 cl</th>
                        <th>Nombre</th>
                        <th>Prix correspondant</th>

                        {% for e in dict_field_active_keg_container %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td>{{ e.1.product_base.product_unit }}</td>
                                    <td><span id="selected_initial_price_active_keg_{{ e.2 }}">{{ e.1.product_base.calculated_price_usual }}</span> €</td>
                                    <td>{{ e.0 }}</td>
                                    <td><span id="selected_price_active_keg_{{ e.2 }}">0</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}

                    </table>
                </div>
                <div class="row" id="div_container_liquor">
                    <table>
                        <th>Produit</th>
                        <th>Prix 4 cl</th>
                        <th>Nombre</th>
                        <th>Prix correspondant</th>

                        {% for e in dict_field_container_liquor %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td>{{ e.1.product_unit }}</td>
                                    <td><span id="selected_initial_price_container_liquor_{{ e.2 }}">{{ e.1.calculated_price_usual }}</span> €</td>
                                    <td>{{ e.0 }}</td>
                                    <td> <span id="selected_price_container_liquor_{{ e.2 }}">0</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="row" id="div_container_syrup">
                    <table>
                        <th>Produit</th>
                        <th>Prix 4 cl</th>
                        <th>Nombre</th>
                        <th>Prix correspondant</th>
                        {% for e in dict_field_container_syrup %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td>{{ e.1.product_unit }}</td>
                                    <td><span id="selected_initial_price_container_syrup_{{ e.2 }}">{{ e.1.calculated_price_usual }}</span> €</td>
                                    <td>{{ e.0 }}</td>
                                    <td> <span id="selected_price_container_syrup_{{ e.2 }}">0</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="row" id="div_single_product">
                    <table>
                        <th>Produit</th>
                        <th>Prix</th>
                        <th>Nombre</th>
                        <th>Prix correspondant</th>

                        {% for e in dict_field_single_product %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td>{{ e.1 }}</td>
                                    <td><span id="selected_initial_price_single_product_{{ e.2 }}">{{ e.1.calculated_price }}</span> €</td>
                                    <td>{{ e.0 }}</td>
                                    <td> <span id="selected_price_single_product_{{ e.2 }}">0</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}

                    </table>
                </div>
                <div class="row" id="div_soft">
                    <table>
                        <th>Produit</th>
                        <th>Prix 25 cl</th>
                        <th>Nombre</th>
                        <th>Prix correspondant</th>

                        {% for e in dict_field_container_soft %}
                            <tr>
                                <div class="fieldWrapper">
                                    <td>{{ e.1.product_unit }}</td>
                                    <td><span id="selected_initial_price_container_soft_{{ e.2 }}">{{ e.1.calculated_price_usual }}</span> €</td>
                                    <td>{{ e.0 }}</td>
                                    <td> <span id="selected_price_container_soft_{{ e.2 }}">0</span> €</td>
                                </div>
                            </tr>
                        {% endfor %}

                    </table>
                </div>
            </div>
        </div>
    </form>
    <script>
        onglets = document.getElementById('onglets');
        var li_list = onglets.getElementsByTagName('li');
        div_list = [];
        div_list.push(document.getElementById('div_active_keg_container'));
        div_list.push(document.getElementById('div_single_product'));
        div_list.push(document.getElementById('div_container_liquor'));
        div_list.push(document.getElementById('div_container_syrup'));
        div_list.push(document.getElementById('div_soft'));
        var active_li = 0;

        // initialisation -> affichage des tireuses par défaut
        set_active_li(0);


        document.getElementById('li_active_keg_container').addEventListener('click', function(e) {
            set_active_li(0);
        }, false);
        document.getElementById('li_single_product').addEventListener('click', function(e) {
            set_active_li(1);
        }, false);
        document.getElementById('li_liquor').addEventListener('click', function(e) {
            set_active_li(2);
        }, false);
        document.getElementById('li_syrup').addEventListener('click', function(e) {
            set_active_li(3);
        }, false);
        document.getElementById('li_soft').addEventListener('click', function(e) {
            set_active_li(4);
        }, false);

        document.onkeyup = function(e) {
            if (e.keyCode == 37 && active_li>0) { // Flêche gauche
                set_active_li(active_li - 1);
            }
            if (e.keyCode == 39 && active_li<li_list.length-1) { // Flêche droite
                set_active_li(active_li + 1);
            }
            if (e.keyCode == 13) { // Flêche droite
                document.getElementById('form_purchase').submit();
            }
        };

        function set_active_li(new_active_li) {
            active_li = new_active_li;
            display_none_all(div_list[active_li]);
        }

        function display_none_all(div_except) {
            for (i=0; i<div_list.length; i++) {
                if (div_list[i] != div_except) {
                    li_list[i].className = '';
                    div_list[i].style.display = 'none';
                }
                else {
                    div_list[i].style.display = 'block';
                    li_list[i].className = 'active';
                }
            }
        }

        function update_consumption() {
            var sum_active_keg = 0;
            var sum_single_product = 0;
            var sum_container_soft = 0;
            var sum_container_liquor = 0;
            var sum_container_syrup = 0;

            for (i=0; i<{{ active_keg_container_list|length }}; i++) {
                sum_active_keg += Number(document.getElementById("selected_price_active_keg_" + i).textContent);
            }
            for (i=0; i<{{ single_product_available_list|length }}; i++) {
                sum_single_product += Number(document.getElementById("selected_price_single_product_" + i).textContent);
            }
            for (i=0; i<{{ container_soft_list|length }}; i++) {
                sum_container_soft += Number(document.getElementById("selected_price_container_soft_" + i).textContent);
            }
            for (i=0; i<{{ container_liquor_list|length }}; i++) {
                sum_container_liquor += Number(document.getElementById("selected_price_container_liquor_" + i).textContent);
            }
            for (i=0; i<{{ container_syrup_list|length }}; i++) {
                sum_container_syrup += Number(document.getElementById("selected_price_container_syrup_" + i).textContent);
            }
            var balance_before = Number(document.getElementById("balance_before").textContent.replace(",","."));
            document.getElementById("total_consumption").textContent = String((sum_active_keg+sum_single_product+sum_container_soft+sum_container_liquor+sum_container_syrup).toFixed(2));
            document.getElementById("balance_after").textContent = String((balance_before-sum_active_keg-sum_single_product-sum_container_soft-sum_container_liquor-sum_container_syrup).toFixed(2));
        }

        var selected_quantity_active_keg = [];
        var selected_price_active_keg = [];
        var selected_initial_price_active_keg = [];
        var selected_quantity_single_product = [];
        var selected_price_single_product = [];
        var selected_initial_price_single_product = [];
        var selected_quantity_container_soft = [];
        var selected_price_container_soft = [];
        var selected_initial_price_container_soft = [];
        var selected_quantity_container_liquor = [];
        var selected_price_container_liquor = [];
        var selected_initial_price_container_liquor = [];
        var selected_quantity_container_syrup = [];
        var selected_price_container_syrup = [];
        var selected_initial_price_container_syrup = [];

        for (i=0; i<{{ active_keg_container_list|length }}; i++) {
            selected_price_active_keg.push(document.getElementById("selected_price_active_keg_"+i));
            selected_quantity_active_keg.push(document.getElementById("id_field_active_keg_container_"+i));
            selected_initial_price_active_keg.push(document.getElementById("selected_initial_price_active_keg_"+i));
        }
        for (i=0; i<{{ single_product_available_list|length }}; i++) {
            selected_price_single_product.push(document.getElementById("selected_price_single_product_"+i));
            selected_quantity_single_product.push(document.getElementById("id_field_single_product_"+i));
            selected_initial_price_single_product.push(document.getElementById("selected_initial_price_single_product_"+i));
        }
        for (i=0; i<{{ container_soft_list|length }}; i++) {
            selected_price_container_soft.push(document.getElementById("selected_price_container_soft_"+i));
            selected_quantity_container_soft.push(document.getElementById("id_field_container_soft_"+i));
            selected_initial_price_container_soft.push(document.getElementById("selected_initial_price_container_soft_"+i));
        }
        for (i=0; i<{{ container_liquor_list|length }}; i++) {
            selected_price_container_liquor.push(document.getElementById("selected_price_container_liquor_"+i));
            selected_quantity_container_liquor.push(document.getElementById("id_field_container_liquor_"+i));
            selected_initial_price_container_liquor.push(document.getElementById("selected_initial_price_container_liquor_"+i));
        }
        for (i=0; i<{{ container_syrup_list|length }}; i++) {
            selected_price_container_syrup.push(document.getElementById("selected_price_container_syrup_"+i));
            selected_quantity_container_syrup.push(document.getElementById("id_field_container_syrup_"+i));
            selected_initial_price_container_syrup.push(document.getElementById("selected_initial_price_container_syrup_"+i));
        }
        for(i=0;i<{{ active_keg_container_list|length }};i++){
            (function(x) {
                selected_quantity_active_keg[i].addEventListener('change', function(e) {
                    selected_price_active_keg[x].textContent = String((e.target.value * Number(selected_initial_price_active_keg[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }
        for(i=0;i<{{ single_product_available_list|length }};i++){
            (function(x) {
                selected_quantity_single_product[i].addEventListener('change', function(e) {
                    selected_price_single_product[x].textContent = String((e.target.value * Number(selected_initial_price_single_product[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }
        for(i=0;i<{{ container_soft_list|length }};i++){
            (function(x) {
                selected_quantity_container_soft[i].addEventListener('change', function(e) {
                    selected_price_container_soft[x].textContent = String((e.target.value * Number(selected_initial_price_container_soft[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }
        for(i=0;i<{{ container_liquor_list|length }};i++){
            (function(x) {
                selected_quantity_container_liquor[i].addEventListener('change', function(e) {
                    selected_price_container_liquor[x].textContent = String((e.target.value * Number(selected_initial_price_container_liquor[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }
        for(i=0;i<{{ container_syrup_list|length }};i++){
            (function(x) {
                selected_quantity_container_syrup[i].addEventListener('change', function(e) {
                    selected_price_container_syrup[x].textContent = String((e.target.value * Number(selected_initial_price_container_syrup[x].textContent.replace(",", "."))).toFixed(2));
                    update_consumption();
                }, false);
            })(i);
        }
    </script>

{% endblock %}